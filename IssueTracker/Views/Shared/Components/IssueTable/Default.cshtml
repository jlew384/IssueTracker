@using System.Security.Claims;
@using IssueTracker.Helpers;
@using IssueTracker.Constants;
@model IssueTableComponentViewModel

@{
    ViewData["Title"] = "Index";
    var user = User as ClaimsPrincipal;
    string userId = user.FindFirst(ClaimTypes.NameIdentifier).Value;
    var ownerClaimValues = user.Claims
         .Where(c => c.Type == UserClaimTypes.PROJECT_OWNER)
         .Select(c => Int32.Parse(c.Value))
         .ToList();
}

<div class="">
    <table sortField="@Model.SortField" sortDirection="@Model.SortDirection" class="table table-hover table-responsive">
        <thead>
            <tr class="">
                <th tag="sort-button" field="@IssueSortOrder.TITLE" role="button" class="border-1" style="width: 25%;">
                    @Html.DisplayNameFor(model => model.Issues.FirstOrDefault().Title)
                    @if(Model.SortField == IssueSortOrder.TITLE)
                    {
                        if(Model.SortDirection == IssueSortOrder.DESC)
                        {
                            <i class="bi bi-caret-down-fill"></i>
                        }
                        else
                        {                            
                            <i class="bi bi-caret-up-fill"></i>
                        }
                    }
                </th>
                <th tag="sort-button" field="@IssueSortOrder.CREATOR" role="button" class="border-1 d-none d-xxl-table-cell" style="width: 5%;">
                    @Html.DisplayNameFor(model => model.Issues.FirstOrDefault().CreatorUser)
                    @if(Model.SortField == IssueSortOrder.CREATOR)
                    {
                        if(Model.SortDirection == IssueSortOrder.DESC)
                        {
                            <i class="bi bi-caret-down-fill"></i>
                        }
                        else
                        {                            
                            <i class="bi bi-caret-up-fill"></i>
                        }
                    }
                </th>
                <th tag="sort-button" field="@IssueSortOrder.CREATED_DATE" role="button" class="border-1" style="width: 5%;">
                    @Html.DisplayNameFor(model => model.Issues.FirstOrDefault().Created)
                    @if(Model.SortField == IssueSortOrder.CREATED_DATE)
                    {
                        if(Model.SortDirection == IssueSortOrder.DESC)
                        {
                            <i class="bi bi-caret-down-fill"></i>
                        }
                        else
                        {                            
                            <i class="bi bi-caret-up-fill"></i>
                        }
                    }
                    
                </th>
                <th tag="sort-button" field="@IssueSortOrder.STATUS" role="button" class="border-1" style="width: 5%;">
                    @Html.DisplayNameFor(model => model.Issues.FirstOrDefault().Status)
                    @if(Model.SortField == IssueSortOrder.STATUS)
                    {
                        if(Model.SortDirection == IssueSortOrder.DESC)
                        {
                            <i class="bi bi-caret-down-fill"></i>
                        }
                        else
                        {                            
                            <i class="bi bi-caret-up-fill"></i>
                        }
                    }
                </th>
                <th tag="sort-button" field="@IssueSortOrder.PRIORITY" role="button" class="border-1" style="width: 5%;">
                    @Html.DisplayNameFor(model => model.Issues.FirstOrDefault().Priority)
                    @if(Model.SortField == IssueSortOrder.PRIORITY)
                    {
                        if(Model.SortDirection == IssueSortOrder.DESC)
                        {
                            <i class="bi bi-caret-down-fill"></i>
                        }
                        else
                        {                            
                            <i class="bi bi-caret-up-fill"></i>
                        }
                    }
                </th>
                <th tag="sort-button" field="@IssueSortOrder.TYPE" role="button" class="border-1" style="width: 5%;">
                    @Html.DisplayNameFor(model => model.Issues.FirstOrDefault().Type)
                    @if(Model.SortField == IssueSortOrder.TYPE)
                    {
                        if(Model.SortDirection == IssueSortOrder.DESC)
                        {
                            <i class="bi bi-caret-down-fill"></i>
                        }
                        else
                        {                            
                            <i class="bi bi-caret-up-fill"></i>
                        }
                    }
                </th>
                <th tag="sort-button" field="@IssueSortOrder.ASSIGNED_USER_NAME" role="button" class="border-1 d-none d-lg-table-cell" style="width: 5%;">
                    @Html.DisplayNameFor(model => model.Issues.FirstOrDefault().AssignedUser)
                    @if(Model.SortField == IssueSortOrder.ASSIGNED_USER_NAME)
                    {
                        if(Model.SortDirection == IssueSortOrder.DESC)
                        {
                            <i class="bi bi-caret-down-fill"></i>
                        }
                        else
                        {                            
                            <i class="bi bi-caret-up-fill"></i>
                        }
                    }
                </th>
                <th class="d-none" style="width: 2%;"></th>
            </tr>
        </thead>
        <tbody>
            @if(Model.Issues.Count > 0)
            {
                foreach(var issue in Model.Issues)
                {
                    <tr tag="issue-row" issueId="@issue.Id">
                        <td>
                            @Html.DisplayFor(issueItem => issue.Title)
                        </td>
                        <td class="d-none d-xxl-table-cell text-nowrap">
                            @Html.DisplayFor(issueItem => issue.CreatorUser.UserName)
                        </td>
                        <td class="text-muted">
                            @DateTimeHelpers.GetSimpleElapsedTime(issue.Created)
                        </td>
                        <td>
                            @switch(issue.Status)
                            {
                                case IssueStatus.TO_DO:
                                    <select tag="status-dropdown" asp-for="@issue.Status" issueId="@issue.Id" class="status-dropdown form-select-sm bg-success text-white border-0" asp-items="@new SelectList(IssueStatus.List)" ></select>
                                    break;
                                case IssueStatus.IN_PROGRESS:
                                    <select tag="status-dropdown" asp-for="@issue.Status" issueId="@issue.Id" class="status-dropdown form-select-sm bg-info text-white border-0" asp-items="@new SelectList(IssueStatus.List)" ></select>
                                    break;
                                case IssueStatus.DONE:
                                    <select tag="status-dropdown" asp-for="@issue.Status" issueId="@issue.Id" class="status-dropdown form-select-sm bg-secondary text-white border-0" asp-items="@new SelectList(IssueStatus.List)" ></select>
                                    break;
                            }
                            
                        </td>
                        <td>
                            <select tag="priority-dropdown" asp-for="@issue.Priority" issueId="@issue.Id" class="priority-dropdown form-select-sm border-0" asp-items="@new SelectList(IssuePriority.List)" ></select>
                        </td>
                        <td>
                            <select tag="type-dropdown" asp-for="@issue.Type" issueId="@issue.Id" class="priority-dropdown form-select-sm border-0" asp-items="@new SelectList(IssueType.List)" ></select>
                        </td>
                        <td class="d-none d-lg-table-cell text-nowrap">
                            @Html.DisplayFor(issueItem => issue.AssignedUser.UserName)
                        </td>                        
                        <td class="d-none">
                            
                            @if(User.IsInRole(UserRoles.ADMIN) || userId == issue.CreatorUserId || User.IsInRole(UserRoles.PROJ_MNGR) && ownerClaimValues.Contains(issue.ProjectId))
                            {
                                <div class="text-nowrap">
                                    <a class="m-1 text-muted" asp-controller="Issue" asp-action="Edit" asp-route-id="@issue.Id" asp-route-pid="@issue.ProjectId"><i class="bi bi-pencil-fill"></i></a>
                                    <a class="m-1 text-muted" asp-controller="Issue" asp-action="Delete" asp-route-id="@issue.Id" asp-route-pid="@issue.ProjectId"><i class="bi bi-trash2-fill"></i></a>
                                </div>
                    
                            }  
                        </td>
                    </tr>
                }
            }                
        </tbody>
    </table>
</div>